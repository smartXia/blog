<html><head><meta charset="utf-8"><title>13 用复合字面值作初值构造器-慕课专栏</title>
			<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
			<meta name="renderer" content="webkit">
			<meta property="qc:admins" content="77103107776157736375">
			<meta property="wb:webmaster" content="c4f857219bfae3cb">
			<meta http-equiv="Access-Control-Allow-Origin" content="*">
			<meta http-equiv="Cache-Control" content="no-transform ">
			<meta http-equiv="Cache-Control" content="no-siteapp">
			<link rel="apple-touch-icon" sizes="76x76" href="https://www.imooc.com/static/img/common/touch-icon-ipad.png">
			<link rel="apple-touch-icon" sizes="120x120" href="https://www.imooc.com/static/img/common/touch-icon-iphone-retina.png">
			<link rel="apple-touch-icon" sizes="152x152" href="https://www.imooc.com/static/img/common/touch-icon-ipad-retina.png">
			<link href="https://moco.imooc.com/captcha/style/captcha.min.css" rel="stylesheet">
			<link rel="stylesheet" href="https://www.imooc.com/static/moco/v1.0/dist/css/moco.min.css?t=201907021539" type="text/css">
			<link rel="stylesheet" href="https://www.imooc.com/static/lib/swiper/swiper-3.4.2.min.css?t=201907021539">
			<link rel="stylesheet" href="https://static.mukewang.com/static/css/??base.css,common/common-less.css?t=2.5,column/zhuanlanChapter-less.css?t=2.5,course/inc/course_tipoff-less.css?t=2.5?v=201907051055" type="text/css">
			<link charset="utf-8" rel="stylesheet" href="https://www.imooc.com/static/lib/ueditor/themes/imooc/css/ueditor.css?v=201907021539"><link rel="stylesheet" href="https://www.imooc.com/static/lib/baiduShare/api/css/share_style0_16.css?v=6aba13f0.css"></head>
			<body><div id="main">


<div class="main-con hide-menu">
    <!-- 左侧菜单 & 索引 -->
    
    <div class="right-content" style="padding-left: 0px;">
        <div class="container clearfix" id="top" style="width: 1134px; display: block;">
            
            
            <div class="center_con js-center_con l" style="width: 1134px;">
                <div class="article-con">
                                            <!-- 买过的阅读 -->
                        

                    
                    <div class="art-title" style="margin-top: 0px;">
                        13 用复合字面值作初值构造器
                    </div>
                    <div class="art-info clearfix">
                        
                        <span class="l">
                            更新时间：2020-10-12 10:37:23
                        </span>
                    </div>
                    <div class="art-top">
                                                <img src="https://img4.sycdn.imooc.com/5f683f640001af9d06400426.jpg" alt="">
                                                                        <div class="famous-word-box">
                            <img src="https://www.imooc.com/static/img/column/bg-l.png" alt="" class="bg1 bg">
                            <img src="https://www.imooc.com/static/img/column/bg-r.png" alt="" class="bg2 bg">
                            <div class="famous-word">知识是一种快乐，而好奇则是知识的萌芽。——培根<p></p></div>
                        </div>
                                            </div>
                    <div class="art-content js-lookimg">
                        <div id="article_content">
                            <div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在上一节中，我们了解到了“零值可用”对于编写出符合 Go 惯用法的代码是大有裨益的。但有些时候，零值并非是最好的选择，我们有必要要为变量赋予适当的初值以保证其后续以正确的“状态”参与到业务流程计算中去，尤其是 Go 语言中的一些类型为复合类型的变量。Go 语言中的复合类型包括结构体、数组、切片和 map。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">对于复合类型变量，最常见的值构造方式就是对其内部元素做逐个赋值，比如：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go"><span class="token keyword">var</span> s myStruct
s<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"tony"</span>
s<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">23</span>

<span class="token keyword">var</span> a <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token builtin">int</span>
a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">13</span>
a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">14</span>
<span class="token operator">...</span> <span class="token operator">...</span>
a<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">17</span>

sl <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
sl<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">23</span>
sl<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">24</span>
<span class="token operator">...</span> <span class="token operator">...</span>
sl<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">27</span>

m <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>
m<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"hello"</span>
m<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"gopher"</span>
m<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"!"</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">但这样的值构造方式让代码显得有些“繁琐”，尤其是在构造组成较为复杂的复合类型变量初值的时候。Go 提供的<a href="https://golang.org/ref/spec#Composite_literals">复合字面值（composite literals）</a>语法可以作为复合类型变量的初值构造器。使用复合字面值上述代码可以改写成下面这样：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go">s <span class="token operator">:=</span> myStruct <span class="token punctuation">{</span><span class="token string">"tony"</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">}</span>
a <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">}</span>
sl <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">}</span>
m <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token string">"gopher"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span><span class="token string">"!"</span><span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">显然，代码得到了很大的简化。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们看到复合字面值由两部分组成，一部分是<strong>类型</strong>，比如上述例子中赋值操作符右侧的 myStruct、[5]int、[]int、map[int]string，另外一部分是由大括号 {} 包裹的字面值。这里的字面值形式还仅仅是 Go 复合字面值作为值构造器的基本用法。下面我们来分别看看复合字面值对于不同复合类型的“高级用法”。</p>
</div><div class="cl-preview-section"><h2 id="结构体复合字面值" style="font-size: 30px;">1. 结构体复合字面值</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">使用 <a href="https://tip.golang.org/cmd/vet/">go vet</a> 工具对 Go 源码进行过静态代码分析的童鞋们可能会知道，go vet 工具中默认内置了一条检查规则：<strong><a href="https://github.com/golang/tools/tree/master/go/analysis/passes/composite">“composites”</a></strong>。下面是源码中对该规则的描述：</p>
</div><div class="cl-preview-section"><pre class="  language-plain"><code class="prism  language-plain">此分析器对源码中使用复合字面值对struct变量赋值的行为进行诊断：

如果源码使用从另一个包(package)中导入的struct类型，但不使用field:value语法形式进行值构造的，分析器认为这样的复合字面值是脆弱的。因为一旦结构体增加了一个新的字段（即使未导出），这种值构造方式也将导致编译失败。

举个例子：
    err = &amp;net.DNSConfigError{err}
应该替换为：
    err = &amp;net.DNSConfigError{Err: err}
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Go 推荐使用 “field:value” 格式的复合字面值形式对 struct 类型变量进行值构造，这种值构造方式可以降低结构体类型使用者与结构体类型设计者之间的耦合。这也是 Go 语言的惯用法，在 Go 标准库中，通过"field:value"格式复合字面值进行结构体类型变量初值构造的例子比比皆是：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go"><span class="token comment">// $GOROOT/src/net/http/transport.go</span>
<span class="token keyword">var</span> DefaultTransport RoundTripper <span class="token operator">=</span> <span class="token operator">&amp;</span>Transport<span class="token punctuation">{</span>
        Proxy<span class="token punctuation">:</span> ProxyFromEnvironment<span class="token punctuation">,</span>
        DialContext<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>net<span class="token punctuation">.</span>Dialer<span class="token punctuation">{</span>
                Timeout<span class="token punctuation">:</span>   <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
                KeepAlive<span class="token punctuation">:</span> <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
                DualStack<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>DialContext<span class="token punctuation">,</span>
        MaxIdleConns<span class="token punctuation">:</span>          <span class="token number">100</span><span class="token punctuation">,</span>
        IdleConnTimeout<span class="token punctuation">:</span>       <span class="token number">90</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
        TLSHandshakeTimeout<span class="token punctuation">:</span>   <span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
        ExpectContinueTimeout<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// $GOROOT/src/io/pipe.go</span>

<span class="token keyword">type</span> pipe <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        wrMu sync<span class="token punctuation">.</span>Mutex <span class="token comment">// Serializes Write operations</span>
        wrCh <span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
        rdCh <span class="token keyword">chan</span> <span class="token builtin">int</span>

        once sync<span class="token punctuation">.</span>Once <span class="token comment">// Protects closing done</span>
        done <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        rerr atomicError
        werr atomicError
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Pipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>PipeReader<span class="token punctuation">,</span> <span class="token operator">*</span>PipeWriter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        p <span class="token operator">:=</span> <span class="token operator">&amp;</span>pipe<span class="token punctuation">{</span>
                wrCh<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                rdCh<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                done<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">&amp;</span>PipeReader<span class="token punctuation">{</span>p<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>PipeWriter<span class="token punctuation">{</span>p<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们看到这种 “field:value” 形式的复合字面值初值构造器颇为强大。和之前普通复合字面值形式相比，“field:value” 形式字面值中的字段可以以任意次序出现，未显式出现在字面值的结构体中的字段将采用其对应类型的零值。以上面的 pipe 为例，Pipe 函数在使用复合字面值对其类型变量进行初值构造时仅对 wrCh、rdCh 和 done 做了 “field:value” 形式的显式赋值，这样 pipe 结构体中的其他变量的值将为其类型的初值，比如 wrMu。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">从上面例子我们还可以看到：通过在复合字面值值构造器的类型前面增加&amp;，我们可以得到对应类型的指针类型变量，如上面例子中的 p 的类型为 Pipe 类型指针。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">复合字面值作为结构体值构造器的大量使用，使得即便采用类型零值时我们也会使用字面值构造器形式：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go">s <span class="token operator">:=</span> myStruct<span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">而较少使用 new 这一个 Go 预定义的函数来创建结构体变量实例：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go">s <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>myStruct<span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">值得注意的是：使用从其他包导入的结构体中的未导出字段作为复合字面值中的 field 是不被允许的，会导致编译错误。</p>
</div><div class="cl-preview-section"><h2 id="数组切片复合字面值" style="font-size: 30px;">2. 数组/切片复合字面值</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">和结构体类型不同，数组/切片使用下标（index）作为 “field:value” 形式中 “field”，从而实现数组/切片初始元素值的高级构造形式：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go">numbers <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token string">'a'</span><span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span>

<span class="token comment">// [10]float{-1, 0, 0, 0, -0.1, -0.1, 0, 0.1, 0, -1}</span>
fnumbers <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span>float<span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span>

<span class="token comment">// $GOROOT/src/sort/search_test.go</span>
<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">:</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> sdata <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">"f"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">"foobar"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token string">"x"</span><span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">和结构体复合字面值较多采用 “field:value” 形式作为值构造器不同的是，数组/切片由于其固有的特性，采用 “index:value” 为其构造初值主要应用在少数场合，比如：为非连续（稀疏）元素构造初值（上面的 numbers、fnumbers)、让编译器根据最大元素下标值推导数组的 Size（如上面的 fnumbers）等。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">另外在编写单元测试时，为了更显著体现元素对应的下标值，可能会使用 “index:value” 形式来为数组/切片进行值构造，如上面标准库单元测试源码中的 data、sdata。</p>
</div><div class="cl-preview-section"><h2 id="map-复合字面值" style="font-size: 30px;">3. map 复合字面值</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">和结构体、数组/切片相比，map 类型变量使用复合字面值作为初值构造器就显得自然了许多，因为 map 类型具有原生的 “key:value” 抽象形式：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go"><span class="token comment">// $GOROOT/src/time/format.go</span>
<span class="token keyword">var</span> unitMap <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">{</span>
        <span class="token string">"ns"</span><span class="token punctuation">:</span> <span class="token function">int64</span><span class="token punctuation">(</span>Nanosecond<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"us"</span><span class="token punctuation">:</span> <span class="token function">int64</span><span class="token punctuation">(</span>Microsecond<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"µs"</span><span class="token punctuation">:</span> <span class="token function">int64</span><span class="token punctuation">(</span>Microsecond<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// U+00B5 = micro symbol</span>
        <span class="token string">"μs"</span><span class="token punctuation">:</span> <span class="token function">int64</span><span class="token punctuation">(</span>Microsecond<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// U+03BC = Greek letter mu</span>
        <span class="token string">"ms"</span><span class="token punctuation">:</span> <span class="token function">int64</span><span class="token punctuation">(</span>Millisecond<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"s"</span><span class="token punctuation">:</span>  <span class="token function">int64</span><span class="token punctuation">(</span>Second<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"m"</span><span class="token punctuation">:</span>  <span class="token function">int64</span><span class="token punctuation">(</span>Minute<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"h"</span><span class="token punctuation">:</span>  <span class="token function">int64</span><span class="token punctuation">(</span>Hour<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>


<span class="token comment">// $GOROOT/src/net/http/server.go</span>

<span class="token keyword">type</span> ConnState <span class="token builtin">int</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span> 
        StateNew ConnState <span class="token operator">=</span> <span class="token boolean">iota</span>
        StateActive
        StateIdle
        StateHijacked
	StateClosed
<span class="token punctuation">)</span>

<span class="token keyword">var</span> stateName <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span>ConnState<span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
        StateNew<span class="token punctuation">:</span>      <span class="token string">"new"</span><span class="token punctuation">,</span>
        StateActive<span class="token punctuation">:</span>   <span class="token string">"active"</span><span class="token punctuation">,</span>
        StateIdle<span class="token punctuation">:</span>     <span class="token string">"idle"</span><span class="token punctuation">,</span>
        StateHijacked<span class="token punctuation">:</span> <span class="token string">"hijacked"</span><span class="token punctuation">,</span>
        StateClosed<span class="token punctuation">:</span>   <span class="token string">"closed"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">对于数组/切片类型而言，当元素的类型为复合类型时，我们可以省去元素复合字面量中的类型，比如：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go"><span class="token keyword">type</span> Point <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	x <span class="token builtin">float64</span>
	y <span class="token builtin">float64</span>
<span class="token punctuation">}</span>

sl <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Point<span class="token punctuation">{</span>
	<span class="token punctuation">{</span><span class="token number">1.2345</span><span class="token punctuation">,</span> <span class="token number">6.2789</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// Point{1.2345, 6.2789}</span>
	<span class="token punctuation">{</span><span class="token number">2.2345</span><span class="token punctuation">,</span> <span class="token number">19.2789</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// Point{2.2345, 19.2789}</span>
<span class="token punctuation">}</span>

</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">但是对于 map 类型而言，这一优化在 <a href="https://tip.golang.org/doc/go1.5">Go 1.5</a> 中才得以引入。引入后，当 key 或 value 的类型为复合类型时，我们可以省去 key 或 value 中的复合字面量中的类型：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go"><span class="token comment">// Go 1.5版本之前:</span>


m <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span>Point<span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
    Point<span class="token punctuation">{</span><span class="token number">29.935523</span><span class="token punctuation">,</span> <span class="token number">52.891566</span><span class="token punctuation">}</span><span class="token punctuation">:</span>   <span class="token string">"Persepolis"</span><span class="token punctuation">,</span>
    Point<span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">25.352594</span><span class="token punctuation">,</span> <span class="token number">131.034361</span><span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token string">"Uluru"</span><span class="token punctuation">,</span>
    Point<span class="token punctuation">{</span><span class="token number">37.422455</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">122.084306</span><span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token string">"Googleplex"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

vs<span class="token punctuation">.</span>

<span class="token comment">// Go 1.5版本及之后</span>

m <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span>Point<span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
    <span class="token punctuation">{</span><span class="token number">29.935523</span><span class="token punctuation">,</span> <span class="token number">52.891566</span><span class="token punctuation">}</span><span class="token punctuation">:</span>   <span class="token string">"Persepolis"</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">25.352594</span><span class="token punctuation">,</span> <span class="token number">131.034361</span><span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token string">"Uluru"</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token number">37.422455</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">122.084306</span><span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token string">"Googleplex"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

m1 <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Point<span class="token punctuation">{</span>
    <span class="token string">"Persepolis"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token number">29.935523</span><span class="token punctuation">,</span> <span class="token number">52.891566</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"Uluru"</span><span class="token punctuation">:</span>      <span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">25.352594</span><span class="token punctuation">,</span> <span class="token number">131.034361</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"Googleplex"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token number">37.422455</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">122.084306</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">对于 key 或 value 为指针类型的情况，我们也可以省略 “&amp;T”：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go">m2 <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Point<span class="token punctuation">{</span>
    <span class="token string">"Persepolis"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token number">29.935523</span><span class="token punctuation">,</span> <span class="token number">52.891566</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">// &amp;Point {29.935523, 52.891566}</span>
    <span class="token string">"Uluru"</span><span class="token punctuation">:</span>      <span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">25.352594</span><span class="token punctuation">,</span> <span class="token number">131.034361</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// &amp;Point{-25.352594, 131.034361}</span>
    <span class="token string">"Googleplex"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token number">37.422455</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">122.084306</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// &amp;Point{37.422455, -122.084306}</span>
<span class="token punctuation">}</span>

fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>m2<span class="token punctuation">)</span> <span class="token comment">// map[Googleplex:0xc0000ae050 Persepolis:0xc0000ae030 Uluru:0xc0000ae040]</span>
</code></pre>
</div><div class="cl-preview-section"><h2 id="小结" style="font-size: 30px;">4. 小结</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">对于零值不适用的场景，我们要为变量赋予一定的初值。对于复合类型而言，我们应该首选 Go 提供的复合字面值作为初值构造器。对于不同复合类型，我们要记住下面几点：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">使用 “field:value” 形式的复合字面值为结构体类型的变量赋初值；</li>
<li style="font-size: 20px; line-height: 38px;">在为稀疏元素赋值或让编译器推导数组 Size 的时候，多使用 “index:value” 的形式为数组/切片类型变量赋初值；</li>
<li style="font-size: 20px; line-height: 38px;">使用 “key:value” 形式的复合字面值为 map 类型的变量赋初值。</li>
</ul>
</div>}
                        </div>
                    </div>
                                            <!-- 买过的阅读 -->
                        <div class="art-next-prev clearfix">
                                                                                                <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/87/article/2381">
                                                                    <div class="prev l clearfix">
                                        <div class="icon l">
                                            <i class="imv2-arrow3_l"></i>
                                        </div>
                                        <p>
                                            12 定义“零值可用”的类型
                                        </p>
                                    </div>
                                </a>
                                                                                                                            <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/87/article/2383">
                                                                    <div class="next r clearfix">
                                        <p>
                                            14 深入理解和高效运用切片(slice)
                                        </p>
                                        <div class="icon r">
                                            <i class="imv2-arrow3_r"></i>
                                        </div>

                                    </div>
                                </a>
                                                    </div>
                                    </div>
                <div class="comments-con js-comments-con" id="coments_con">
                </div>

                
            </div>
            
            
            

        </div>
    </div>
</div>

<div class="modal modal-jiaQun-new hide" id="modal-jiaQun">
    <div class="inner" style="">
        <div class="modal-close js-close-jiaQun">
            <i class="imv2-close"></i>
        </div>
        <div class="content">
            <img src="https://img1.sycdn.imooc.com/5f51ecec0001392b05330597.jpg">
            <div class="right-info">
                <div class="title">
                    扫码加入慕课前沿技术核心用户群
                </div>
                <div class="desc">
                                            <p class="mb6">验证信息：<span id="joincode">2010312025386365</span><span class="copy js-copy-joincode">复制</span></p>
                                        <p class="mb6">QQ讨论群号：729941811</p>
                                            <p>QQ群URL：<a href="https://jq.qq.com/?_wv=1027&amp;k=5WJLMxV" target="_blank">点击访问</a></p>
                                    </div>
            </div>
            <p class="tip">若遇到搜索不到QQ群或加群失败，请联系客服邮箱:kf@imooc.com</p>
        </div>
    </div>
</div>
 
<!-- 专栏介绍页专栏评价 -->

<!-- 专栏介绍页底部三条评价 -->

<!-- 专栏阅读页弹层目录和介绍页页面目录 -->

<!-- 专栏阅读页发布回复 -->

<!-- 专栏阅读页发布评论 -->

<!-- 专栏阅读页底部评论 -->

<!-- 专栏阅读 单个 评论 -->

<!-- 新增回复和展开三条以外回复 -->

<!-- 立即订阅的弹窗 -->












</div></body></html>