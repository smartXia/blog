<html><head><meta charset="utf-8"><title>19 defer 让你的代码更清晰-慕课专栏</title>
			<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
			<meta name="renderer" content="webkit">
			<meta property="qc:admins" content="77103107776157736375">
			<meta property="wb:webmaster" content="c4f857219bfae3cb">
			<meta http-equiv="Access-Control-Allow-Origin" content="*">
			<meta http-equiv="Cache-Control" content="no-transform ">
			<meta http-equiv="Cache-Control" content="no-siteapp">
			<link rel="apple-touch-icon" sizes="76x76" href="https://www.imooc.com/static/img/common/touch-icon-ipad.png">
			<link rel="apple-touch-icon" sizes="120x120" href="https://www.imooc.com/static/img/common/touch-icon-iphone-retina.png">
			<link rel="apple-touch-icon" sizes="152x152" href="https://www.imooc.com/static/img/common/touch-icon-ipad-retina.png">
			<link href="https://moco.imooc.com/captcha/style/captcha.min.css" rel="stylesheet">
			<link rel="stylesheet" href="https://www.imooc.com/static/moco/v1.0/dist/css/moco.min.css?t=201907021539" type="text/css">
			<link rel="stylesheet" href="https://www.imooc.com/static/lib/swiper/swiper-3.4.2.min.css?t=201907021539">
			<link rel="stylesheet" href="https://static.mukewang.com/static/css/??base.css,common/common-less.css?t=2.5,column/zhuanlanChapter-less.css?t=2.5,course/inc/course_tipoff-less.css?t=2.5?v=201907051055" type="text/css">
			<link charset="utf-8" rel="stylesheet" href="https://www.imooc.com/static/lib/ueditor/themes/imooc/css/ueditor.css?v=201907021539"><link rel="stylesheet" href="https://www.imooc.com/static/lib/baiduShare/api/css/share_style0_16.css?v=6aba13f0.css"></head>
			<body><div id="main">


<div class="main-con hide-menu">
    <!-- 左侧菜单 & 索引 -->
    
    <div class="right-content" style="padding-left: 0px;">
        <div class="container clearfix" id="top" style="width: 1134px; display: block;">
            
            
            <div class="center_con js-center_con l" style="width: 1134px;">
                <div class="article-con">
                                            <!-- 买过的阅读 -->
                        

                    
                    <div class="art-title" style="margin-top: 0px;">
                        19 defer 让你的代码更清晰
                    </div>
                    <div class="art-info clearfix">
                        
                        <span class="l">
                            更新时间：2020-10-27 09:52:47
                        </span>
                    </div>
                    <div class="art-top">
                                                <img src="https://img2.sycdn.imooc.com/5f924c28000117ff06400426.jpg" alt="">
                                                                        <div class="famous-word-box">
                            <img src="https://www.imooc.com/static/img/column/bg-l.png" alt="" class="bg1 bg">
                            <img src="https://www.imooc.com/static/img/column/bg-r.png" alt="" class="bg2 bg">
                            <div class="famous-word">青年是学习智慧的时期，中年是付诸实践的时期。 —— 卢梭<p></p></div>
                        </div>
                                            </div>
                    <div class="art-content js-lookimg">
                        <div id="article_content">
                            <div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">日常开发中，我们经常会编写一些类似下面示例中的代码：</p>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go"><span class="token comment">// deferred_func_1.go</span>

<span class="token keyword">func</span> <span class="token function">writeToFile</span><span class="token punctuation">(</span>fname <span class="token builtin">string</span><span class="token punctuation">,</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> mu <span class="token operator">*</span>sync<span class="token punctuation">.</span>Mutex<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	f<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_RDWR<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">Seek</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	err <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	err <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们看到这类代码的特点就是在函数中会申请一些资源并在函数退出前释放或关闭这些资源，比如这里的文件描述符 f 和互斥锁 mu。函数的实现需要确保这些资源在函数退出时被及时正确地释放，无论函数的执行流是按预期顺利进行还是出现错误。为此，开发人员需对函数中的错误处理尤为关注，在错误处理时不能遗漏对资源的释放，尤其是有多个资源需要释放的时候，就像上面示例那样，这大大增加了开发人员的心智负担。同时当待释放的资源个数较多时，整个代码逻辑将变得十分复杂，程序可读性、健壮性也随之下降。但即便如此，如果函数实现中的某段代码逻辑抛出 panic，传统的错误处理机制依然没有办法捕获它并尝试从 panic 恢复。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">解决上述提到的这些问题正是 Go 语言引入 defer 的初衷。</p>
</div><div class="cl-preview-section"><h2 id="defer-的运作机制" style="font-size: 30px;">1. defer 的运作机制</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">defer 的运作离不开函数，这里至少有两点含义：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">在 Go 中，只有在函数(和方法)内部才能使用 defer；</li>
<li style="font-size: 20px; line-height: 38px;">defer 关键字后面只能接函数(或方法），这些函数被称为 deferred 函数。defer 将它们注册到其所在 goroutine 用于存放 deferred 函数的栈数据结构中，这些 deferred 函数将在执行 defer 的函数退出前被按后进先出(LIFO)的顺序调度执行(如下图所示)。</li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img1.sycdn.imooc.com/5f9248db0001f3af10361046.png" data-original="//img1.sycdn.imooc.com/5f9248db0001f3af10361046.png" alt=""></p>
</div><div class="cl-preview-section"><center>图4-3-1：deferred函数的存储与调度执行</center>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">无论是执行到函数体尾部返回，还是在某个错误处理分支显式 return，亦或是出现 panic，已经存储到 deferred 函数栈中的函数都会被调度执行。因此，deferred 函数是一个可以在任何情况下都可以为函数进行<strong>收尾工作</strong>的好场合。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们回到本节开头的例子，我们把收尾工作挪到 deferred 函数中，代码变更后如下：</p>
</div><div class="cl-preview-section"><pre class=" language-plain"><code class="prism  language-plain">// deferred_func_2.go(这里仅列出writeToFile变更后的代码)
func writeToFile(fname string, data []byte, mu *sync.Mutex) error {
	mu.Lock()
	defer mu.Unlock()
	f, err := os.OpenFile(fname, os.O_RDWR, 0666)
	if err != nil {
		return err
	}
	defer f.Close()

	_, err = f.Seek(0, 2)
	if err != nil {
		return err
	}

	_, err = f.Write(data)
	if err != nil {
		return err
	}

	return f.Sync()
}
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们看到 defer 的使用对函数 writeToFile 的实现逻辑的简化是显而易见的，资源释放函数的 defer 注册动作紧邻着资源申请成功的动作，这样成对出现的惯例极大降低了遗漏资源释放的可能性，开发人员也因此再也不用小心翼翼地在每个错误处理分支中检查是否遗漏了某个资源的释放动作了。同时，代码的简化又意味代码可读性的提高以及健壮性的增强。</p>
</div><div class="cl-preview-section"><h2 id="defer-的常见用法" style="font-size: 30px;">2. defer 的常见用法</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">除了释放资源这个最基本、最常见的用法之外，defer 的运作机制决定了它还可以在其他一些场合发挥作用，这些用法在 Go 标准库中均有体现。</p>
</div><div class="cl-preview-section"><h3 id="拦截-panic">1) 拦截 panic</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在上一小节我们提到过，defer 的运行机制决定了无论函数是执行到函数体末尾正常返回，还是在函数体中的某个错误处理分支显式调用 return 返回，亦或是函数体内部出现 panic，已经注册了的 deferred 函数都会被调度执行。因此，defer 的第二个重要用途就是用来拦截 panic，并按需要对 panic 进行处理，可以尝试从 panic 中恢复（这也是 Go 语言中唯一一种从 panic 恢复的手段），也可以如下面标准库代码中这样，重新 panic，但为新的 panic 传一个新的 error 值：</p>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go"><span class="token comment">// $GOROOT/src/bytes/buffer.go</span>
<span class="token keyword">func</span> <span class="token function">makeSlice</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">{</span>
        <span class="token comment">// If the make fails, give a known error.</span>
        <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                        <span class="token function">panic</span><span class="token punctuation">(</span>ErrTooLarge<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">下面代码则是通过 deferred 函数拦截 panic 并恢复了程序的继续运行：</p>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go"><span class="token comment">// deferred_func_3.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"raise a panic"</span><span class="token punctuation">)</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> e <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"recovered from a panic"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"main exit normally"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

$ <span class="token keyword">go</span> run deferred_func_3<span class="token punctuation">.</span><span class="token keyword">go</span>
raise a <span class="token builtin">panic</span>
recovered from a <span class="token builtin">panic</span>
main exit normally
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">deferred 函数在 panic 的情况下依旧能够被调度执行的特性让下面两个看似行为等价的函数在 panic 的时候得到不同的执行结果：</p>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go"><span class="token keyword">var</span> mu sync<span class="token punctuation">.</span>Mutex

<span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">bizOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">bizOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">当 bizOperation 抛出 panic 时，函数 g 无法释放 mutex，而函数 f 则可以释放 mutex，让后续函数依旧可以申请 mutex 资源。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">虽然 deferred 函数可以拦截到绝大部分的 panic，但有些 runtime 之外的致命问题也是无法拦截并恢复的，比如下面代码中通过 C 代码”制造“的 crash，deferred 函数便无能为力：</p>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go"><span class="token comment">// deferred_func_4.go</span>
<span class="token keyword">package</span> main

<span class="token comment">//#include &lt;stdio.h&gt;</span>
<span class="token comment">// void crash() {</span>
<span class="token comment">//    int *q = NULL;</span>
<span class="token comment">//    (*q) = 15000;</span>
<span class="token comment">//    printf("%d\n", *q);</span>
<span class="token comment">// }</span>
<span class="token keyword">import</span> <span class="token string">"C"</span>

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	C<span class="token punctuation">.</span><span class="token function">crash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> e <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"recovered from a panic:"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"main exit normally"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">执行这段代码我们就会看到虽然有 deferred 函数拦截，但程序仍然崩溃掉了：</p>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go">$ <span class="token keyword">go</span> run deferred_func_4<span class="token punctuation">.</span><span class="token keyword">go</span>
SIGILL<span class="token punctuation">:</span> illegal instruction
PC<span class="token operator">=</span><span class="token number">0x409a7f4</span> m<span class="token operator">=</span><span class="token number">0</span> sigcode<span class="token operator">=</span><span class="token number">1</span>

goroutine <span class="token number">0</span> <span class="token punctuation">[</span>idle<span class="token punctuation">]</span><span class="token punctuation">:</span>
runtime<span class="token punctuation">:</span> unknown pc <span class="token number">0x409a7f4</span>
<span class="token operator">...</span> <span class="token operator">...</span>
</code></pre>
</div><div class="cl-preview-section"><h3 id="deferred-函数可以修改函数的具名返回值">2) deferred 函数可以修改函数的具名返回值</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">下面是 Go 标准库中通过 deferred 函数访问函数具名返回值变量的两个例子：</p>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go"><span class="token comment">// $GOROOT/src/fmt/scan.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>ss<span class="token punctuation">)</span> <span class="token function">Token</span><span class="token punctuation">(</span>skipSpace <span class="token builtin">bool</span><span class="token punctuation">,</span> f <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">rune</span><span class="token punctuation">)</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>tok <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> e <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> se<span class="token punctuation">,</span> ok <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token punctuation">(</span>scanError<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
                                err <span class="token operator">=</span> se<span class="token punctuation">.</span>err
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                <span class="token function">panic</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token operator">...</span> <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token comment">// $GOROOT/SRC/net/ipsock_plan9.go </span>
<span class="token keyword">func</span> <span class="token function">dialPlan9</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> net <span class="token builtin">string</span><span class="token punctuation">,</span> laddr<span class="token punctuation">,</span> raddr Addr<span class="token punctuation">)</span> <span class="token punctuation">(</span>fd <span class="token operator">*</span>netFD<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">fixErr</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token operator">...</span> <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们也来写一个更直观的示例：</p>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go"><span class="token comment">// deferred_func_5.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		x <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token number">5</span>
		y <span class="token operator">=</span> y <span class="token operator">*</span> <span class="token number">10</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	x <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token number">5</span>
	y <span class="token operator">=</span> b <span class="token operator">+</span> <span class="token number">6</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	x<span class="token punctuation">,</span> y <span class="token operator">:=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"x="</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> <span class="token string">"y="</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">运行这个程序：</p>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go">$ <span class="token keyword">go</span> run deferred_func_5<span class="token punctuation">.</span><span class="token keyword">go</span>
x<span class="token operator">=</span> <span class="token number">30</span> y<span class="token operator">=</span> <span class="token number">80</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们看到 deferred 函数在 foo 真正将执行权返回给 main 函数之前将 foo 的两个返回值 x 和 y 分别作了 5 倍和 10 倍放大。</p>
</div><div class="cl-preview-section"><h3 id="deferred-函数可以用于输出一些调试信息">3) deferred 函数可以用于输出一些调试信息</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">deferred 函数被注册以及调度执行的时间点十分适合用来输出一些调试信息。比如下面 Go 标准库中 net 包中的 hostLookupOrder 方法就使用 deferred 函数在特定日志级别下输出一些日志便于程序调试和跟踪。</p>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go"><span class="token comment">// $GOROOT/src/net/conf.go</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>conf<span class="token punctuation">)</span> <span class="token function">hostLookupOrder</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Resolver<span class="token punctuation">,</span> hostname <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>ret hostLookupOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> c<span class="token punctuation">.</span>dnsDebugLevel <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">{</span>
                <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"go package net: hostLookupOrder("</span><span class="token punctuation">,</span> hostname<span class="token punctuation">,</span> <span class="token string">") = "</span><span class="token punctuation">,</span> ret<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
	<span class="token operator">...</span> <span class="token operator">...</span>

<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">更为典型的莫过于在出入函数时打印留痕日志(一般在调试日志级别下)，这里摘录一下 Go 官方参考文档中提供的一个实现：</p>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go"><span class="token keyword">func</span> <span class="token function">trace</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"entering:"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>
    <span class="token keyword">return</span> s
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">un</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"leaving:"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> <span class="token function">un</span><span class="token punctuation">(</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"in a"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> <span class="token function">un</span><span class="token punctuation">(</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"in b"</span><span class="token punctuation">)</span>
    <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><h3 id="还原变量旧值">4) 还原变量旧值</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">defer 还有一种比较小众的用法，这用法依旧是来自对 Go 标准库源码的阅读。在 syscall 包下面有这样的一段代码：</p>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go"><span class="token comment">// $GOROOT/src/syscall/fs_nacl.go</span>
<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// do not trigger loading of zipped file system here</span>
        oldFsinit <span class="token operator">:=</span> fsinit
        <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> fsinit <span class="token operator">=</span> oldFsinit <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        fsinit <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token function">Mkdir</span><span class="token punctuation">(</span><span class="token string">"/dev"</span><span class="token punctuation">,</span> <span class="token number">0555</span><span class="token punctuation">)</span>
        <span class="token function">Mkdir</span><span class="token punctuation">(</span><span class="token string">"/tmp"</span><span class="token punctuation">,</span> <span class="token number">0777</span><span class="token punctuation">)</span>
        <span class="token function">mkdev</span><span class="token punctuation">(</span><span class="token string">"/dev/null"</span><span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">,</span> openNull<span class="token punctuation">)</span>
        <span class="token function">mkdev</span><span class="token punctuation">(</span><span class="token string">"/dev/random"</span><span class="token punctuation">,</span> <span class="token number">0444</span><span class="token punctuation">,</span> openRandom<span class="token punctuation">)</span>
        <span class="token function">mkdev</span><span class="token punctuation">(</span><span class="token string">"/dev/urandom"</span><span class="token punctuation">,</span> <span class="token number">0444</span><span class="token punctuation">,</span> openRandom<span class="token punctuation">)</span>
        <span class="token function">mkdev</span><span class="token punctuation">(</span><span class="token string">"/dev/zero"</span><span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">,</span> openZero<span class="token punctuation">)</span>
        <span class="token function">chdirEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们看到这段源码的作者利用了 deferred 函数对变量的旧值进行还原：即先将 fsinit 存储在一个局部变量 oldFsinit 中，然后在 deferred 函数中将 fsinit 的值重新置为存储在 oldFsinit 中的旧值。</p>
</div><div class="cl-preview-section"><h2 id="关于-defer-使用的几个关键问题" style="font-size: 30px;">3. 关于 defer 使用的几个关键问题</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">绝大多数 Gopher 都喜欢 defer，它让函数变得简洁且健壮。 但”工欲善其事,必先利其器“，一旦要用 defer，有几个关于 defer 使用的关键问题是需要提前了解清楚的，以避免掉进一些不必要的”坑“。</p>
</div><div class="cl-preview-section"><h3 id="明确哪些函数可以作为-deferred-函数">1) 明确哪些函数可以作为 deferred 函数</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">对于自定义的函数或方法，defer 可以给与无条件的支持，但是对于有返回值的自定义函数或方法，返回值会在 deferred 函数被调度执行的时候被自动丢弃掉。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Go 语言中除了自定义函数/方法，还有 Go 语言内置的/预定义的函数，下面是 Go 语言内置函数的完全列表：</p>
</div><div class="cl-preview-section"><pre><code>Functions:
	append cap close complex copy delete imag len
	make new panic print println real recover
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">内置函数是否都能作为 deferred 函数呢？我们看一下下面的示例：</p>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go"><span class="token comment">// deferred_func_6.go </span>
<span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// builtin functions:</span>
	<span class="token comment">//	append cap close complex copy delete imag len</span>
	<span class="token comment">// 	make new panic print println real recover</span>

	<span class="token keyword">var</span> c <span class="token keyword">chan</span> <span class="token builtin">int</span>
	<span class="token keyword">var</span> sl <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
	<span class="token keyword">var</span> m <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
	m<span class="token punctuation">[</span><span class="token string">"item1"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
	m<span class="token punctuation">[</span><span class="token string">"item2"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>
	<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">complex</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.4</span><span class="token punctuation">)</span>

	<span class="token keyword">var</span> sl1 <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>

	<span class="token keyword">defer</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">append</span><span class="token punctuation">(</span>sl<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cap</span><span class="token punctuation">(</span>sl<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">complex</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">copy</span><span class="token punctuation">(</span>sl1<span class="token punctuation">,</span> sl<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">delete</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token string">"item2"</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">imag</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">len</span><span class="token punctuation">(</span>sl<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">panic</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"hello, defer\n"</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello, defer"</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">real</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">运行该实例：</p>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go">$
<span class="token keyword">go</span> run deferred_func_6<span class="token punctuation">.</span><span class="token keyword">go</span> 
# command<span class="token operator">-</span>line<span class="token operator">-</span>arguments
<span class="token punctuation">.</span><span class="token operator">/</span>deferred_func_6<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">22</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span> <span class="token keyword">defer</span> discards result of <span class="token function">append</span><span class="token punctuation">(</span>sl<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token operator">/</span>deferred_func_6<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">23</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span> <span class="token keyword">defer</span> discards result of <span class="token function">cap</span><span class="token punctuation">(</span>sl<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token operator">/</span>deferred_func_6<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">25</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span> <span class="token keyword">defer</span> discards result of <span class="token function">complex</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token operator">/</span>deferred_func_6<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">28</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span> <span class="token keyword">defer</span> discards result of <span class="token function">imag</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token operator">/</span>deferred_func_6<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span> <span class="token keyword">defer</span> discards result of <span class="token function">len</span><span class="token punctuation">(</span>sl<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token operator">/</span>deferred_func_6<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">30</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span> <span class="token keyword">defer</span> discards result of <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token operator">/</span>deferred_func_6<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span> <span class="token keyword">defer</span> discards result of <span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token operator">/</span>deferred_func_6<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">35</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span> <span class="token keyword">defer</span> discards result of <span class="token function">real</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们看到 Go 编译器给出一组错误提示！从这组错误提示中我们看到：append、cap、len、make、new 等内置函数是不能直接作为 deferred 函数的，而 close、copy、delete、print、recover 等是可以直接被 defer 注册为 deferred 函数的。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">对于那些不能直接作为 deferred 函数的内置函数，我们可以使用一个包裹它的匿名函数来间接满足要求，以 append 为例：</p>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go"><span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>sl<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">但这么做的实际意义是什么是需要开发者自己把握。</p>
</div><div class="cl-preview-section"><h3 id="把握好-defer-关键字后面表达式的求值时机">2) 把握好 defer 关键字后面表达式的求值时机</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">牢记一点：defer 关键字后面的表达式是在将 deferred 函数注册到 deferred 函数栈的时候进行求值的。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">下面用一个典型的例子来说明一下 defer 后表达式的求值时机：</p>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go"><span class="token comment">// deferred_func_7.go </span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">foo3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"foo1 result:"</span><span class="token punctuation">)</span>
	<span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"\nfoo2 result:"</span><span class="token punctuation">)</span>
	<span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"\nfoo3 result:"</span><span class="token punctuation">)</span>
	<span class="token function">foo3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们对 foo1、foo2 和 foo3 中的 defer 后的表达式的求值时机做逐一分析：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">foo1 中 defer 后面直接用的是 fmt.Println 函数，每当 defer 将 fmt.Println 注册到 deferred 函数栈的时候，都会对 Println 后面的参数进行求值，根据上述代码逻辑，依次压入 deferred 函数栈的函数是：</li>
</ul>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go">fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">因此，当 foo1 返回后，deferred 函数被调度执行时，上述压入栈的 deferred 函数将以 LIFO 次序出栈执行，因此输出的结果为：</p>
</div><div class="cl-preview-section"><pre class=" language-plain"><code class="prism  language-plain">3
2
1
0
</code></pre>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">foo2 中 defer 后面接的是一个带有一个参数的匿名函数。每当 defer 将匿名函数注册到 deferred 函数栈的时候，都会对该匿名函数的参数进行求值，根据上述代码逻辑，依次压入 deferred 函数栈的函数是：</li>
</ul>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go"><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">func</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">func</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">func</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">因此，当 foo2 返回后，deferred 函数被调度执行时，上述压入栈的 deferred 函数将以 LIFO 次序出栈执行，因此输出的结果为：</p>
</div><div class="cl-preview-section"><pre class=" language-plain"><code class="prism  language-plain">3
2
1
0
</code></pre>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">foo3 中 defer 后面接的是一个不带参数的匿名函数。根据上述代码逻辑，依次压入 deferred 函数栈的函数是：</li>
</ul>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go"><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">因此，当 foo3 返回后，deferred 函数被调度执行时，上述压入栈的 deferred 函数将以 LIFO 次序出栈执行。匿名函数以闭包的方式访问外围函数的变量 i，并通过 Println 输出 i 的值，此时 i 的值为 4，因此 foo3 的输出结果为：</p>
</div><div class="cl-preview-section"><pre class=" language-plain"><code class="prism  language-plain">4
4
4
4
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">鉴于 defer 表达式求值时机的重要性，我们再来看一个例子：</p>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go"><span class="token comment">// deferred_func_8.go </span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	sl <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span>sl<span class="token punctuation">)</span>

	sl <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> sl
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	sl <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span>p <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sl<span class="token punctuation">)</span>

	sl <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> sl
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们分别分析一下这个实例中的 foo1、foo2 函数：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">foo1 中 defer 后面的匿名函数接收一个切片类型参数，当 defer 将该匿名函数注册到 deferred 函数栈的时候，会对它的参数进行求值，此时传入的变量 sl 的值为[]int{1, 2, 3}，因此压入 deferred 函数栈的函数是：</li>
</ul>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go"><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">之后虽然 sl 被重新赋值，但是当 foo1 返回后，deferred 函数被调度执行时，deferred 函数的参数值依然为[]int{1,2,3}，因此 foo1 输出的结果为：[1 2 3]。</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">foo2 中 defer 后面的匿名函数接收一个切片指针类型参数，当 defer 将该匿名函数注册到 deferred 函数栈的时候，会对它的参数进行求值，此时传入的参数为变量 sl 的地址，因此压入 deferred 函数栈的函数是：</li>
</ul>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go"><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sl<span class="token punctuation">)</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">之后虽然 sl 被重新赋值。当 foo2 返回后，deferred 函数被调度执行时，deferred 函数的参数值依然为 sl 的地址，但此时 sl 的值已经变为[]int{3, 2, 1}，因此 foo2 输出的结果为：[3 2 1]。</p>
</div><div class="cl-preview-section"><h3 id="知晓-defer-带来的性能损耗">3) 知晓 defer 带来的性能损耗</h3>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">defer 让 Gopher 在进行资源释放(如文件描述符、锁)的过程变动优雅很多，也不易出错。但在性能敏感的应用中，defer 带来的性能负担也是 Gopher 必须要知晓和权衡的问题。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们用一个性能基准测试(benchmark)来直观地看看 defer 究竟带来多少性能损耗。</p>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go"><span class="token comment">// defer_perf_benchmark_1_test.go </span>
<span class="token keyword">package</span> defer_test

<span class="token keyword">import</span> <span class="token string">"testing"</span>

<span class="token keyword">func</span> <span class="token function">sum</span><span class="token punctuation">(</span>max <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	total <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		total <span class="token operator">+=</span> i
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> total
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">fooWithDefer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">fooWithoutDefer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkFooWithDefer</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token function">fooWithDefer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">BenchmarkFooWithoutDefer</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token function">fooWithoutDefer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">运行该 benchmark 测试，我们得到如下结果：</p>
</div><div class="cl-preview-section"><pre class=" language-go"><code class="prism  language-go">$ <span class="token keyword">go</span> test <span class="token operator">-</span>bench <span class="token punctuation">.</span> defer_perf_benchmark_1_test<span class="token punctuation">.</span><span class="token keyword">go</span> 
goos<span class="token punctuation">:</span> darwin
goarch<span class="token punctuation">:</span> amd64
BenchmarkFooWithDefer<span class="token number">-8</span>      	<span class="token number">34581608</span>	        <span class="token number">31.6</span> ns<span class="token operator">/</span>op
BenchmarkFooWithoutDefer<span class="token number">-8</span>   	<span class="token number">248793603</span>	         <span class="token number">4.83</span> ns<span class="token operator">/</span>op
PASS
ok  	command<span class="token operator">-</span>line<span class="token operator">-</span>arguments	<span class="token number">2.</span>830s
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">从基准测试结果我们可以清晰的看到：使用 defer 的函数的执行时间是没有使用 defer 函数的 8 倍左右。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在 Go 1.13 中，Go 核心团队对 defer 性能做了大幅优化，官方给出了在大多数情况下，defer 性能提升 30%的说法。但笔者的实测结果是 defer 性能的确有提升，但远没有达到 30%这么大的幅度。在 Go 1.14 版本中，defer 性能据说还有大幅提升，让我们拭目以待。</p>
</div><div class="cl-preview-section"><h2 id="小结" style="font-size: 30px;">4. 小结</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">多数情况下，我们的程序对性能并非那么敏感。在这样的情况下，笔者建议 gopher 们尽量使用 defer。defer 让资源释放变得优雅且不易出错，简化了函数实现逻辑，提高了代码可读性，让函数实现变得更加健壮。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">本节要点：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">理解 defer 的运作机制：deferred 函数注册与调度执行；</li>
<li style="font-size: 20px; line-height: 38px;">了解 defer 的常见用法；</li>
<li style="font-size: 20px; line-height: 38px;">了解 defer 使用的几个关键问题，避免入”坑“。</li>
</ul>
</div>}
                        </div>
                    </div>
                                            <!-- 买过的阅读 -->
                        <div class="art-next-prev clearfix">
                                                                                                <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/87/article/2420">
                                                                    <div class="prev l clearfix">
                                        <div class="icon l">
                                            <i class="imv2-arrow3_l"></i>
                                        </div>
                                        <p>
                                            18 Go 函数是“一等公民”
                                        </p>
                                    </div>
                                </a>
                                                                                                                            <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/87/article/2422">
                                                                    <div class="next r clearfix">
                                        <p>
                                            20 Go 方法的本质
                                        </p>
                                        <div class="icon r">
                                            <i class="imv2-arrow3_r"></i>
                                        </div>

                                    </div>
                                </a>
                                                    </div>
                                    </div>
                <div class="comments-con js-comments-con" id="coments_con">
                </div>

                
            </div>
            
            
            

        </div>
    </div>
</div>

<div class="modal modal-jiaQun-new hide" id="modal-jiaQun">
    <div class="inner" style="">
        <div class="modal-close js-close-jiaQun">
            <i class="imv2-close"></i>
        </div>
        <div class="content">
            <img src="https://img1.sycdn.imooc.com/5f51ecec0001392b05330597.jpg">
            <div class="right-info">
                <div class="title">
                    扫码加入慕课前沿技术核心用户群
                </div>
                <div class="desc">
                                            <p class="mb6">验证信息：<span id="joincode">2010312025386365</span><span class="copy js-copy-joincode">复制</span></p>
                                        <p class="mb6">QQ讨论群号：729941811</p>
                                            <p>QQ群URL：<a href="https://jq.qq.com/?_wv=1027&amp;k=5WJLMxV" target="_blank">点击访问</a></p>
                                    </div>
            </div>
            <p class="tip">若遇到搜索不到QQ群或加群失败，请联系客服邮箱:kf@imooc.com</p>
        </div>
    </div>
</div>
 
<!-- 专栏介绍页专栏评价 -->

<!-- 专栏介绍页底部三条评价 -->

<!-- 专栏阅读页弹层目录和介绍页页面目录 -->

<!-- 专栏阅读页发布回复 -->

<!-- 专栏阅读页发布评论 -->

<!-- 专栏阅读页底部评论 -->

<!-- 专栏阅读 单个 评论 -->

<!-- 新增回复和展开三条以外回复 -->

<!-- 立即订阅的弹窗 -->












</div></body></html>