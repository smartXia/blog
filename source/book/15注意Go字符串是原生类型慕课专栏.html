<html><head><meta charset="utf-8"><title>15 注意：Go 字符串是原生类型-慕课专栏</title>
			<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
			<meta name="renderer" content="webkit">
			<meta property="qc:admins" content="77103107776157736375">
			<meta property="wb:webmaster" content="c4f857219bfae3cb">
			<meta http-equiv="Access-Control-Allow-Origin" content="*">
			<meta http-equiv="Cache-Control" content="no-transform ">
			<meta http-equiv="Cache-Control" content="no-siteapp">
			<link rel="apple-touch-icon" sizes="76x76" href="https://www.imooc.com/static/img/common/touch-icon-ipad.png">
			<link rel="apple-touch-icon" sizes="120x120" href="https://www.imooc.com/static/img/common/touch-icon-iphone-retina.png">
			<link rel="apple-touch-icon" sizes="152x152" href="https://www.imooc.com/static/img/common/touch-icon-ipad-retina.png">
			<link href="https://moco.imooc.com/captcha/style/captcha.min.css" rel="stylesheet">
			<link rel="stylesheet" href="https://www.imooc.com/static/moco/v1.0/dist/css/moco.min.css?t=201907021539" type="text/css">
			<link rel="stylesheet" href="https://www.imooc.com/static/lib/swiper/swiper-3.4.2.min.css?t=201907021539">
			<link rel="stylesheet" href="https://static.mukewang.com/static/css/??base.css,common/common-less.css?t=2.5,column/zhuanlanChapter-less.css?t=2.5,course/inc/course_tipoff-less.css?t=2.5?v=201907051055" type="text/css">
			<link charset="utf-8" rel="stylesheet" href="https://www.imooc.com/static/lib/ueditor/themes/imooc/css/ueditor.css?v=201907021539"><link rel="stylesheet" href="https://www.imooc.com/static/lib/baiduShare/api/css/share_style0_16.css?v=6aba13f0.css"></head>
			<body><div id="main">


<div class="main-con hide-menu">
    <!-- 左侧菜单 & 索引 -->
    
    <div class="right-content" style="padding-left: 0px;">
        <div class="container clearfix" id="top" style="width: 1134px; display: block;">
            
            
            <div class="center_con js-center_con l" style="width: 1134px;">
                <div class="article-con">
                                            <!-- 买过的阅读 -->
                        

                    
                    <div class="art-title" style="margin-top: 0px;">
                        15 注意：Go 字符串是原生类型
                    </div>
                    <div class="art-info clearfix">
                        
                        <span class="l">
                            更新时间：2020-10-19 16:56:55
                        </span>
                    </div>
                    <div class="art-top">
                                                <img src="https://img1.sycdn.imooc.com/5f68464b0001797406400318.jpg" alt="">
                                                                        <div class="famous-word-box">
                            <img src="https://www.imooc.com/static/img/column/bg-l.png" alt="" class="bg1 bg">
                            <img src="https://www.imooc.com/static/img/column/bg-r.png" alt="" class="bg2 bg">
                            <div class="famous-word">才能一旦让懒惰支配，它就一无可为。——克雷洛夫<p></p></div>
                        </div>
                                            </div>
                    <div class="art-content js-lookimg">
                        <div id="article_content">
                            <div class="cl-preview-section"><h2 id="go-语言的字符串类型" style="font-size: 30px;">1. Go 语言的字符串类型</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">字符串类型是现代编程语言中最常使用的数据类型之一。在 Go 语言的先祖之一 C 语言当中，字符串类型并没有被显式定义，而是以字符串字面值常量或以’\0’结尾的字符类型（char）数组来呈现的：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go">#define GOAUTHERS <span class="token string">"Robert Griesemer, Rob Pike, and Ken Thompson"</span>
<span class="token keyword">const</span> char <span class="token operator">*</span> s <span class="token operator">=</span> <span class="token string">"hello world"</span>
char s<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"hello gopher"</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">这给 C 程序员在使用字符串时带来一些问题，诸如：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">类型安全性差；</li>
<li style="font-size: 20px; line-height: 38px;">字符串操作要时时刻刻考虑结尾的’\0’；</li>
<li style="font-size: 20px; line-height: 38px;">字符串数据可变（主要指以字符数组形式定义的字符串类型）；</li>
<li style="font-size: 20px; line-height: 38px;">获取字符串长度代价大（O(n)时间复杂度）；</li>
<li style="font-size: 20px; line-height: 38px;">未内置对非 ASCII 字符（如中文字符）的处理。</li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Go 内置了 string 类型，统一了对“字符串”的抽象。这样无论是字符串常量、字符串变量或是代码中出现的字符串字面值，它们的类型都被统一设置为 string：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go">
<span class="token comment">// sources/string_type.go</span>

<span class="token keyword">package</span> main
  
<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
        s <span class="token operator">=</span> <span class="token string">"string constant"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> s1 <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">"string variable"</span>

        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%T\n"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token comment">// string</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%T\n"</span><span class="token punctuation">,</span> s1<span class="token punctuation">)</span> <span class="token comment">// string</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%T\n"</span><span class="token punctuation">,</span> <span class="token string">"temporary string literal"</span><span class="token punctuation">)</span> <span class="token comment">// string</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Go string 类型设计充分吸取了 C 语言字符串设计的经验教训，并结合了其他主流语言在字符串类型设计上的最佳实践，最终为 Gopher 呈现的 Go string 类型具有如下功能特点：</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>string 类型的数据是不可变的</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">一旦声明了一个 string 类型的标识符，无论是变量还是变量，那么该标识符所指代的数据在整个程序的生命周期内便无法被更改。下面我来尝试修改一下 string 数据，看看能得到怎样的结果。先来看第一种方法：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go"><span class="token comment">// sources/string_immutable1.go</span>

<span class="token keyword">package</span> main
  
<span class="token keyword">import</span> <span class="token punctuation">(</span>
        <span class="token string">"fmt"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// original string</span>
        <span class="token keyword">var</span> s <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">"hello"</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"original string:"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>

        <span class="token comment">// reslice it and try to change the original string</span>
        sl <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
        sl<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'t'</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"slice:"</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>sl<span class="token punctuation">)</span><span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"after reslice, the original string is:"</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">该程序的运行结果如下：</p>
</div><div class="cl-preview-section"><pre><code>$go run string_immutable1.go
original string: hello
slice: tello
after reslice, the original string is: hello
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们看到在例子中我们试图通过将 string 转换为一个 slice 并通过该 slice 对其内容进行修改，但结果事与愿违。对 string 进行 slice 转换后，Go 编译器会为 slice 变量重新分配底层存储而不是共用 string 的底层存储，因此对 slice 的修改并未对原 string 的数据产生任何影响。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们再来试试通过更为“暴力”一些的手段对 string 的数据发起“攻击”：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go">
<span class="token comment">// sources/string_immutable2.go</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"unsafe"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// original string</span>
	<span class="token keyword">var</span> s <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">"hello"</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"original string:"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>

	<span class="token comment">// try to change the original string through unsafe pointer</span>
	<span class="token function">modifyString</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">modifyString</span><span class="token punctuation">(</span>s <span class="token operator">*</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 取出第一个8字节的值</span>
	p <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// 获取底层数组的地址</span>
	<span class="token keyword">var</span> array <span class="token operator">*</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">var</span> <span class="token builtin">len</span> <span class="token operator">*</span><span class="token builtin">int</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">len</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%p =&gt; %c\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>array<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>array<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
		p1 <span class="token operator">:=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>array<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
		v <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>p1<span class="token punctuation">)</span>
		<span class="token punctuation">(</span><span class="token operator">*</span>p1<span class="token punctuation">)</span> <span class="token operator">=</span> v <span class="token operator">+</span> <span class="token number">1</span> <span class="token comment">//try to change the character</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们试图通过 unsafe 指针指向 string 在运行时内部表示结构（具体参考本节后面的讲解）中的数据存储块的地址，然后通过指针修改那块内存中存储的数据。我们运行这段程序得到下面的结果：</p>
</div><div class="cl-preview-section"><pre><code>$go run string_immutable2.go
original string: hello
0x10d1b9d =&gt; h
unexpected fault address 0x10d1b9d
fatal error: fault
[signal SIGBUS: bus error code=0x2 addr=0x10d1b9d pc=0x109b079]
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们看到：对 string 的底层的数据存储区仅能做只读操作，一旦试图修改那块区域的数据，便会得到 SIGBUS 的运行时错误。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>零值可用</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Go string 类型支持零值可用的理念。Go 字符串无需像 C 语言中那样考虑结尾’\0’字符，因此其零值为""，长度为 0。</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go"><span class="token keyword">var</span> s <span class="token builtin">string</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token comment">// s = ""</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 0</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>获取长度的时间复杂度是 O(1) 级别</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Go string 类型数据是不可变的，因此一旦有了初值后，那块数据就不会改变，其长度也不会改变。Go 将这个长度作为一个字段存储在了运行时的 string 类型结构中了（在本节后面有说明）。这样获取 string 长度的操作，即 len(s) 实际上就是读取存储在运行时中的那个长度值，这是一个代价极低的 O(1)操作。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>支持通过+/+=操作符进行字符串连接</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">通过+/+=操作符进行的字符串连接是对开发者体验最好的字符串连接操作，Go 语言支持这种操作。</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go">s <span class="token operator">:=</span> <span class="token string">"Rob Pike, "</span>
s <span class="token operator">=</span> s <span class="token operator">+</span> <span class="token string">"Robert Griesemer, "</span>
s <span class="token operator">+=</span> <span class="token string">" Ken Thompson"</span>

fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token comment">// Rob Pike, Robert Griesemer, Ken Thompson</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>支持各种比较关系操作符：==、!= 、&gt;=、&lt;=、&gt; 和 &lt;</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Go 支持各种比较关系操作符：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go"><span class="token comment">// sources/string_compare.go</span>
<span class="token keyword">package</span> main
  
<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ==</span>
        s1 <span class="token operator">:=</span> <span class="token string">"世界和平"</span>
        s2 <span class="token operator">:=</span> <span class="token string">"世界"</span> <span class="token operator">+</span> <span class="token string">"和平"</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s1 <span class="token operator">==</span> s2<span class="token punctuation">)</span> <span class="token comment">// true</span>

        <span class="token comment">// !=</span>
        s1 <span class="token operator">=</span> <span class="token string">"Go"</span>
        s2 <span class="token operator">=</span> <span class="token string">"C"</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s1 <span class="token operator">!=</span> s2<span class="token punctuation">)</span> <span class="token comment">// true</span>

        <span class="token comment">// &lt; and &lt;=</span>
        s1 <span class="token operator">=</span> <span class="token string">"12345"</span>
        s2 <span class="token operator">=</span> <span class="token string">"23456"</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s1 <span class="token operator">&lt;</span> s2<span class="token punctuation">)</span>  <span class="token comment">// true</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s1 <span class="token operator">&lt;=</span> s2<span class="token punctuation">)</span> <span class="token comment">// true</span>

        <span class="token comment">// &gt; and &gt;=</span>
        s1 <span class="token operator">=</span> <span class="token string">"12345"</span>
        s2 <span class="token operator">=</span> <span class="token string">"123"</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s1 <span class="token operator">&gt;</span> s2<span class="token punctuation">)</span>  <span class="token comment">// true</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s1 <span class="token operator">&gt;=</span> s2<span class="token punctuation">)</span> <span class="token comment">// true</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">鉴于 Go string 是不可变的，因此如果两个字符串的 length 不相同，那么无需比较具体字符串数据，也可以断定两个字符串是不同的；如果 length 相同，则要进一步判断数据指针是否指向同一块底层存储数据。如果相同，则两个字符串是等价的，如果不同，则还需进一步去比对实际的数据内容。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>对非 ASCII 字符提供原生支持</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Go 源文件的字符编码默认为 UTF-8 编码。UTF-8 编码是目前市面上最流行的字符编码格式，囊括了几乎所有主流非 ASCII 字符（包括汉语字符）。Go string 类型也是以 UTF-8 编码作为内码存储将对应的文本存储在内存当中的。我们来看一个例子：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go"><span class="token comment">// sources/string_nonascii.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token comment">// 中文字符  Unicode CodePoint(码点)   UTF8编码</span>
        <span class="token comment">//  中          U+4E2D                  E4B8AD</span>
        <span class="token comment">//  国          U+56FD                  E59BBD</span>
        <span class="token comment">//  欢          U+6B22                  E6ACA2</span>
        <span class="token comment">//  迎          U+8FCE                  E8BF8E</span>
        <span class="token comment">//  您          U+60A8                  E682A8</span>
        s <span class="token operator">:=</span> <span class="token string">"中国欢迎您"</span>
        rs <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">rune</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
        sl <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> rs <span class="token punctuation">{</span> 
                <span class="token keyword">var</span> utf8Bytes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
                <span class="token keyword">for</span> j <span class="token operator">:=</span> i <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">{</span> 
                        utf8Bytes <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>utf8Bytes<span class="token punctuation">,</span> sl<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> 
                fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s =&gt; %X =&gt; %X\n"</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">,</span> utf8Bytes<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>

$<span class="token keyword">go</span> run string_nonascii<span class="token punctuation">.</span><span class="token keyword">go</span>
中 <span class="token operator">=</span><span class="token operator">&gt;</span> 4E2D <span class="token operator">=</span><span class="token operator">&gt;</span> E4B8AD
国 <span class="token operator">=</span><span class="token operator">&gt;</span> 56FD <span class="token operator">=</span><span class="token operator">&gt;</span> E59BBD
欢 <span class="token operator">=</span><span class="token operator">&gt;</span> 6B22 <span class="token operator">=</span><span class="token operator">&gt;</span> E6ACA2
迎 <span class="token operator">=</span><span class="token operator">&gt;</span> 8FCE <span class="token operator">=</span><span class="token operator">&gt;</span> E8BF8E
您 <span class="token operator">=</span><span class="token operator">&gt;</span> 60A8 <span class="token operator">=</span><span class="token operator">&gt;</span> E682A8
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们看到字符串变量 s 中存储的文本是”中国欢迎你“五个汉字字符（非 ASCII 字符范畴），这里我们输出了每个中文字符对应的 Unicode 码点（Code Point，见输出结果的第二列），一个 rune 对应一个码点。UTF-8 编码是 Unicode 码点的一种字符编码形式，也是最常用的一种编码格式，也是 Go 默认的字符编码格式。我们还可以使用其他字符编码格式来映射 Unicode 码点，比如：UTF-16 等。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在 UTF-8 中，大多数中文字符都使用三个字节表示。[]byte(s)的转型让我们获得了 s 底层存储的“复制品”，从而我们得到了每个汉字字符对应的 UTF-8 编码字节(见输出结果的第三列)。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><strong>原生支持多行字符串</strong></p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">C 语言中要构造多行字符串，要么使用多个字符串的自然拼接，要么需要结合续行符"\"，很难控制好格式：</p>
</div><div class="cl-preview-section"><pre class="  language-c"><code class="prism  language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">char</span> <span class="token operator">*</span>s <span class="token operator">=</span> <span class="token string">"好雨知时节，当春乃发生。\n"</span>
<span class="token string">"随风潜入夜，润物细无声。\n"</span>
<span class="token string">"野径云俱黑，江船火独明。\n"</span>
<span class="token string">"晓看红湿处，花重锦官城。"</span><span class="token punctuation">;</span>

<span class="token keyword">char</span> <span class="token operator">*</span>s1 <span class="token operator">=</span> <span class="token string">"好雨知时节，当春乃发生。\n\
随风潜入夜，润物细无声。\n\
野径云俱黑，江船火独明。\n\
晓看红湿处，花重锦官城。"</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> s1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Go 语言直接提供了通过反引号(`)构造“所见即所得”的多行字符串的方法：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go"><span class="token comment">// sources/string_multilines.go</span>
<span class="token keyword">package</span> main
  
<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token string">`好雨知时节，当春乃发生。
随风潜入夜，润物细无声。
野径云俱黑，江船火独明。
晓看红湿处，花重锦官城。`</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

$<span class="token keyword">go</span> run string_multilines<span class="token punctuation">.</span><span class="token keyword">go</span> 
好雨知时节，当春乃发生。
随风潜入夜，润物细无声。
野径云俱黑，江船火独明。
晓看红湿处，花重锦官城。
</code></pre>
</div><div class="cl-preview-section"><h2 id="字符串的内部表示" style="font-size: 30px;">2. 字符串的内部表示</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Go string 类型上述特性的实现与 Go 运行时对 string 类型的内部表示是分不开的。Go string 在运行时表示为下面结构：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go"><span class="token comment">// $GOROOT/src/runtime/string.go</span>
<span class="token keyword">type</span> stringStruct <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        str unsafe<span class="token punctuation">.</span>Pointer
        <span class="token builtin">len</span> <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们看到 string 类型也是一个“描述符”，它本身并不真正存储数据，而仅是由一个指向底层存储的指针和字符串的长度字段组成。我们结合一个 string 的实例化过程来看。下面是 runtime 包中实例化一个字符串对应的函数：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go"><span class="token comment">// $GOROOT/src/runtime/string.go</span>

<span class="token comment">// rawstring allocates storage for a new string. The returned</span>
<span class="token comment">// string and byte slice both refer to the same storage.</span>
<span class="token comment">// The storage is not zeroed. Callers should use</span>
<span class="token comment">// b to set the string contents and then drop b.</span>
<span class="token keyword">func</span> <span class="token function">rawstring</span><span class="token punctuation">(</span>size <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">,</span> b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        p <span class="token operator">:=</span> <span class="token function">mallocgc</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        
        <span class="token function">stringStructOf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span>str <span class="token operator">=</span> p
        <span class="token function">stringStructOf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">len</span> <span class="token operator">=</span> size

        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>slice<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> slice<span class="token punctuation">{</span>p<span class="token punctuation">,</span> size<span class="token punctuation">,</span> size<span class="token punctuation">}</span>

        <span class="token keyword">return</span>
<span class="token punctuation">}</span>       
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们用下面示意图来表示 rawstring 调用后的一个 string 实例的状态：</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;"><img class="" src="https://img1.sycdn.imooc.com/5f68454a00016ade09130896.png" data-original="//img1.sycdn.imooc.com/5f68454a00016ade09130896.png" alt="图片描述"></p>
</div><div class="cl-preview-section"><center>图3-6-1 string类型在运行时的表示</center>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们看到每个字符串类型变量/常量对应一个 stringStruct 实例，经过 rawstring 实例化后，stringStruct 中的 str 指针指向真正存储字符串数据的底层内存区域，len 字段存储的是字符串的长度（这里是 5）；rawstring 同时还创建了一个临时的 slice，该 slice 的 array 指针也同样指向存储字符串数据的底层内存区域。注意 rawstring 调用后，新申请的内存区域还未被写入数据，该 slice 就是用于后续 runtime 层向其写入数据（“hello”）用的，写完数据后，该 slice 就可以被回收掉了，这也是上图中将 slice 结构以虚线框表示的原因。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">通过 string 在运行时的表示我们可以得到这样一个结论，那就是我们直接将 string 类型通过函数/方法参数传入也不会有太多的损耗，因为传入的仅仅是一个“描述符”，而不是真正的字符串数据。我们可以通过一个简单的基准测试来验证一下：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go"><span class="token comment">// sources/string_as_param_benchmark_test.go</span>
<span class="token keyword">package</span> main
  
<span class="token keyword">import</span> <span class="token punctuation">(</span>
        <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> s <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">`Go, also known as Golang, is a statically typed, compiled programming language designed at Google by Robert Griesemer, Rob Pike, and Ken Thompson. Go is syntactically similar to C, but with memory safety, garbage collection, structural typing, and communicating sequential processes (CSP)-style concurrency.`</span>

<span class="token keyword">func</span> <span class="token function">handleString</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token boolean">_</span> <span class="token operator">=</span> s <span class="token operator">+</span> <span class="token string">"hello"</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">handlePtrToString</span><span class="token punctuation">(</span>s <span class="token operator">*</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token boolean">_</span> <span class="token operator">=</span> <span class="token operator">*</span>s <span class="token operator">+</span> <span class="token string">"hello"</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkHandleString</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> n<span class="token operator">++</span> <span class="token punctuation">{</span>
                <span class="token function">handleString</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkHandlePtrToString</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> n<span class="token operator">++</span> <span class="token punctuation">{</span>
                <span class="token function">handlePtrToString</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">运行该基准测试：</p>
</div><div class="cl-preview-section"><pre><code>$go test -bench . -benchmem string_as_param_benchmark_test.go 
goos: darwin
goarch: amd64
BenchmarkHandleString-8        	15668872	        70.7 ns/op	     320 B/op	       1 allocs/op
BenchmarkHandlePtrToString-8   	15809401	        71.8 ns/op	     320 B/op	       1 allocs/op
PASS
ok  	command-line-arguments	2.407s
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们看到直接传入 string 与传入 string 指针两者的基准测试结果几乎一模一样。Gopher 们大可放心地直接使用 string 作为函数/方法参数类型。</p>
</div><div class="cl-preview-section"><h2 id="字符串的高效构造" style="font-size: 30px;">3. 字符串的高效构造</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">前面提到过，Go 原生支持通过 +/+= 操作符来连接多个字符串以构造一个更长的字符串，并且通过 +/+= 操作符的字符串连接构造是最自然、开发体验最好的一种。但 Go 还提供了其他一些构造字符串的方法，比如：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">使用 fmt.Sprintf</li>
<li style="font-size: 20px; line-height: 38px;">使用 strings.Join</li>
<li style="font-size: 20px; line-height: 38px;">使用 strings.Builder</li>
<li style="font-size: 20px; line-height: 38px;">使用 bytes.Buffer</li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在这些方法中哪种方法更为高效呢？我们使用基准测试的数据来做参考：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go"><span class="token comment">// sources/string_concat_benchmark_test.go</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"bytes"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"strings"</span>
	<span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> sl <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
	<span class="token string">"Rob Pike "</span><span class="token punctuation">,</span>
	<span class="token string">"Robert Griesemer "</span><span class="token punctuation">,</span>
	<span class="token string">"Ken Thompson "</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">concatStringByOperator</span><span class="token punctuation">(</span>sl <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> s <span class="token builtin">string</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> sl <span class="token punctuation">{</span>
		s <span class="token operator">+=</span> v
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> s
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">concatStringBySprintf</span><span class="token punctuation">(</span>sl <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> s <span class="token builtin">string</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> sl <span class="token punctuation">{</span>
		s <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s%s"</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> s
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">concatStringByJoin</span><span class="token punctuation">(</span>sl <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>sl<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">concatStringByStringsBuilder</span><span class="token punctuation">(</span>sl <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> b strings<span class="token punctuation">.</span>Builder
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> sl <span class="token punctuation">{</span>
		b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">concatStringByStringsBuilderWithInitSize</span><span class="token punctuation">(</span>sl <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> b strings<span class="token punctuation">.</span>Builder
	b<span class="token punctuation">.</span><span class="token function">Grow</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> sl <span class="token punctuation">{</span>
		b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">concatStringByBytesBuffer</span><span class="token punctuation">(</span>sl <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> b bytes<span class="token punctuation">.</span>Buffer
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> sl <span class="token punctuation">{</span>
		b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">concatStringByBytesBufferWithInitSize</span><span class="token punctuation">(</span>sl <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	buf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
	b <span class="token operator">:=</span> bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> sl <span class="token punctuation">{</span>
		b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkConcatStringByOperator</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> n<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token function">concatStringByOperator</span><span class="token punctuation">(</span>sl<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkConcatStringBySprintf</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> n<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token function">concatStringBySprintf</span><span class="token punctuation">(</span>sl<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkConcatStringByJoin</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> n<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token function">concatStringByJoin</span><span class="token punctuation">(</span>sl<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkConcatStringByStringsBuilder</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> n<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token function">concatStringByStringsBuilder</span><span class="token punctuation">(</span>sl<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkConcatStringByStringsBuilderWithInitSize</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> n<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token function">concatStringByStringsBuilderWithInitSize</span><span class="token punctuation">(</span>sl<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkConcatStringByBytesBuffer</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> n<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token function">concatStringByBytesBuffer</span><span class="token punctuation">(</span>sl<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkConcatStringByBytesBufferWithInitSize</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> n<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token function">concatStringByBytesBufferWithInitSize</span><span class="token punctuation">(</span>sl<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">运行该基准测试：</p>
</div><div class="cl-preview-section"><pre class="  language-plain"><code class="prism  language-plain">$go test -bench=. -benchmem ./string_concat_benchmark_test.go
goos: darwin
goarch: amd64
BenchmarkConcatStringByOperator-8                     	11744653	        89.1 ns/op	      80 B/op	       2 allocs/op
BenchmarkConcatStringBySprintf-8                      	 2792876	       420 ns/op	     176 B/op	       8 allocs/op
BenchmarkConcatStringByJoin-8                         	22923051	        49.1 ns/op	      48 B/op	       1 allocs/op
BenchmarkConcatStringByStringsBuilder-8               	11347185	        96.6 ns/op	     112 B/op	       3 allocs/op
BenchmarkConcatStringByStringsBuilderWithInitSize-8   	26315769	        42.3 ns/op	      64 B/op	       1 allocs/op
BenchmarkConcatStringByBytesBuffer-8                  	14265033	        82.6 ns/op	     112 B/op	       2 allocs/op
BenchmarkConcatStringByBytesBufferWithInitSize-8      	24777525	        48.1 ns/op	      48 B/op	       1 allocs/op
PASS
ok  	command-line-arguments	8.816s

</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">从基准测试的输出结果的第三列，即每操作耗时的数值来看：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">做了预初始化的 strings.Builder 连接构建字符串效率最高；</li>
<li style="font-size: 20px; line-height: 38px;">带有预初始化的 bytes.Buffer 和 strings.Join 两种方法不相伯仲，分列二三位；</li>
<li style="font-size: 20px; line-height: 38px;">未预初始的 strings.Builder、bytes.Buffer 和操作符连接在第三档次；</li>
<li style="font-size: 20px; line-height: 38px;">fmt.Sprintf性能最差，排在末尾。</li>
</ul>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">由此可以得出一些结论：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">在能预估出最终字符串长度的情况下，使用预初始化的 strings.Builder 连接构建字符串效率最高；</li>
<li style="font-size: 20px; line-height: 38px;">strings.Join 连接构造字符串的平均性能最稳定，如果输入的多个字符串是以[]string 承载，那么 strings.Join 也是不错的选择；</li>
<li style="font-size: 20px; line-height: 38px;">使用操作符连接的方式最直观、最自然；如果在编译器可以知晓预连接的字符串个数，那么使用此种方式可以得到编译器的优化处理；</li>
<li style="font-size: 20px; line-height: 38px;">fmt.Sprintf 虽然效率不高，但也不是一无是处；如果是由多种不同类型变量来构造特定格式的字符串，那么这种方式还是最适合的。</li>
</ul>
</div><div class="cl-preview-section"><h2 id="字符串相关的高效转换" style="font-size: 30px;">4. 字符串相关的高效转换</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在前面的例子中，我们看到了 string 到[]rune 以及 string 到[]byte 的转换，这两个转换也是可逆的，也就是说 string 和[]rune、[]byte 可以双向相互转换。下面就是从[]rune 或[]byte 反向转换为 string 的例子：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go"><span class="token comment">// sources/string_slice_to_string.go</span>
<span class="token keyword">package</span> main
  
<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rs <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">rune</span><span class="token punctuation">{</span>
                <span class="token number">0x4E2D</span><span class="token punctuation">,</span>
                <span class="token number">0x56FD</span><span class="token punctuation">,</span>
                <span class="token number">0x6B22</span><span class="token punctuation">,</span>
                <span class="token number">0x8FCE</span><span class="token punctuation">,</span>
                <span class="token number">0x60A8</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        s <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span>rs<span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> 

        sl <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span>
                <span class="token number">0xE4</span><span class="token punctuation">,</span> <span class="token number">0xB8</span><span class="token punctuation">,</span> <span class="token number">0xAD</span><span class="token punctuation">,</span>
                <span class="token number">0xE5</span><span class="token punctuation">,</span> <span class="token number">0x9B</span><span class="token punctuation">,</span> <span class="token number">0xBD</span><span class="token punctuation">,</span>
                <span class="token number">0xE6</span><span class="token punctuation">,</span> <span class="token number">0xAC</span><span class="token punctuation">,</span> <span class="token number">0xA2</span><span class="token punctuation">,</span>
                <span class="token number">0xE8</span><span class="token punctuation">,</span> <span class="token number">0xBF</span><span class="token punctuation">,</span> <span class="token number">0x8E</span><span class="token punctuation">,</span>
                <span class="token number">0xE6</span><span class="token punctuation">,</span> <span class="token number">0x82</span><span class="token punctuation">,</span> <span class="token number">0xA8</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        s <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span>sl<span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

$<span class="token keyword">go</span> run string_slice_to_string<span class="token punctuation">.</span><span class="token keyword">go</span>
中国欢迎您
中国欢迎您
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">无论是 string 转 slice 还是 slice 转 string，转换都是要付出代价的，这些代价的根源在于 string 是不可变的，运行时要为转换后的类型分配新内存。我们以 byte slice 与 string 相互转换为例，看看转换过程的内存分配情况：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go"><span class="token comment">// sources/string_mallocs_in_convert.go</span>

<span class="token keyword">package</span> main
  
<span class="token keyword">import</span> <span class="token punctuation">(</span>
        <span class="token string">"fmt"</span>
        <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">byteSliceToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sl <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span>
                <span class="token number">0xE4</span><span class="token punctuation">,</span> <span class="token number">0xB8</span><span class="token punctuation">,</span> <span class="token number">0xAD</span><span class="token punctuation">,</span>
                <span class="token number">0xE5</span><span class="token punctuation">,</span> <span class="token number">0x9B</span><span class="token punctuation">,</span> <span class="token number">0xBD</span><span class="token punctuation">,</span>
                <span class="token number">0xE6</span><span class="token punctuation">,</span> <span class="token number">0xAC</span><span class="token punctuation">,</span> <span class="token number">0xA2</span><span class="token punctuation">,</span>
                <span class="token number">0xE8</span><span class="token punctuation">,</span> <span class="token number">0xBF</span><span class="token punctuation">,</span> <span class="token number">0x8E</span><span class="token punctuation">,</span>
                <span class="token number">0xE6</span><span class="token punctuation">,</span> <span class="token number">0x82</span><span class="token punctuation">,</span> <span class="token number">0xA8</span><span class="token punctuation">,</span>
                <span class="token number">0xEF</span><span class="token punctuation">,</span> <span class="token number">0xBC</span><span class="token punctuation">,</span> <span class="token number">0x8C</span><span class="token punctuation">,</span>
                <span class="token number">0xE5</span><span class="token punctuation">,</span> <span class="token number">0x8C</span><span class="token punctuation">,</span> <span class="token number">0x97</span><span class="token punctuation">,</span>
                <span class="token number">0xE4</span><span class="token punctuation">,</span> <span class="token number">0xBA</span><span class="token punctuation">,</span> <span class="token number">0xAC</span><span class="token punctuation">,</span>
                <span class="token number">0xE6</span><span class="token punctuation">,</span> <span class="token number">0xAC</span><span class="token punctuation">,</span> <span class="token number">0xA2</span><span class="token punctuation">,</span>
                <span class="token number">0xE8</span><span class="token punctuation">,</span> <span class="token number">0xBF</span><span class="token punctuation">,</span> <span class="token number">0x8E</span><span class="token punctuation">,</span>
                <span class="token number">0xE6</span><span class="token punctuation">,</span> <span class="token number">0x82</span><span class="token punctuation">,</span> <span class="token number">0xA8</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token boolean">_</span> <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span>sl<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">stringToByteSlice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        s <span class="token operator">:=</span> <span class="token string">"中国欢迎您，北京换欢您"</span>
        <span class="token boolean">_</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>testing<span class="token punctuation">.</span><span class="token function">AllocsPerRun</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> byteSliceToString<span class="token punctuation">)</span><span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>testing<span class="token punctuation">.</span><span class="token function">AllocsPerRun</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> stringToByteSlice<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">运行这个例子：</p>
</div><div class="cl-preview-section"><pre class="  language-plain"><code class="prism  language-plain">$go run string_mallocs_in_convert.go
1
1
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们看到：针对"中国欢迎您，北京换欢您"这个长度的字符串，在 string 与 byte slice 互转的过程中都要有一次的内存分配操作。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在 Go 运行时层面，字符串与 rune slice、byte slice 相互转换对应的函数如下：</p>
</div><div class="cl-preview-section"><pre class="  language-plain"><code class="prism  language-plain">// $GOROOT/src/runtime/string.go
slicebytetostring: []byte -&gt; string
slicerunetostring: []rune -&gt; string
stringtoslicebyte: string -&gt; []byte
stringtoslicerune: string -&gt; []rune
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">我们以 byte slice 为例，看看 slicebytetostring 和 stringtoslicebyte 的实现：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go"><span class="token comment">// $GOROOT/src/runtime/string.go</span>

<span class="token comment">// The constant is known to the compiler.</span>
<span class="token comment">// There is no fundamental theory behind this number.</span>
<span class="token keyword">const</span> tmpStringBufSize <span class="token operator">=</span> <span class="token number">32</span>
<span class="token keyword">type</span> tmpBuf <span class="token punctuation">[</span>tmpStringBufSize<span class="token punctuation">]</span><span class="token builtin">byte</span>

<span class="token keyword">func</span> <span class="token function">stringtoslicebyte</span><span class="token punctuation">(</span>buf <span class="token operator">*</span>tmpBuf<span class="token punctuation">,</span> s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
        <span class="token keyword">if</span> buf <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token function">len</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token operator">*</span>buf <span class="token operator">=</span> tmpBuf<span class="token punctuation">{</span><span class="token punctuation">}</span>
                b <span class="token operator">=</span> buf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                b <span class="token operator">=</span> <span class="token function">rawbyteslice</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">copy</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> s<span class="token punctuation">)</span>
        <span class="token keyword">return</span> b
<span class="token punctuation">}</span>


<span class="token keyword">func</span> <span class="token function">slicebytetostring</span><span class="token punctuation">(</span>buf <span class="token operator">*</span>tmpBuf<span class="token punctuation">,</span> b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>str <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        l <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
        <span class="token keyword">if</span> l <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                <span class="token comment">// Turns out to be a relatively common case.</span>
                <span class="token comment">// Consider that you want to parse out data between parens in "foo()bar",</span>
                <span class="token comment">// you find the indices and convert the subslice to string.</span>
                <span class="token keyword">return</span> <span class="token string">""</span>
        <span class="token punctuation">}</span>       

        <span class="token comment">// ... ... 此处省略一些代码</span>

        <span class="token keyword">if</span> l <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
                <span class="token function">stringStructOf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>str<span class="token punctuation">)</span><span class="token punctuation">.</span>str <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>staticbytes<span class="token punctuation">[</span>b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token function">stringStructOf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>str<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">len</span> <span class="token operator">=</span> <span class="token number">1</span>
                <span class="token keyword">return</span>
        <span class="token punctuation">}</span>       
        
        <span class="token keyword">var</span> p unsafe<span class="token punctuation">.</span>Pointer
        <span class="token keyword">if</span> buf <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token function">len</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                p <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                p <span class="token operator">=</span> <span class="token function">mallocgc</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>       
        <span class="token function">stringStructOf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>str<span class="token punctuation">)</span><span class="token punctuation">.</span>str <span class="token operator">=</span> p
        <span class="token function">stringStructOf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>str<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">len</span> <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
        <span class="token function">memmove</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>slice<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>array<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">欲要更高效地进行转换，唯一的方法就是减少和避免额外的内存分配操作。我们看到运行时实现转换的函数中已经加入了一些避免每种情况都要分配新内存操作的优化(比如：tmpBuf 的复用)。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">slice 类型是不可比较的，而 string 类型是可比较的，因此在日常 Go 编码中，我们会经常遇到将 slice 临时转换为 string 的情况。Go 编译器为这样的场景提供了优化。在运行时中有一个名为 slicebytetostringtmp 的函数就是协助实现这一优化的：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go"><span class="token comment">// $GOROOT/src/runtime/string.go</span>
<span class="token keyword">func</span> <span class="token function">slicebytetostringtmp</span><span class="token punctuation">(</span>b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> raceenabled <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                <span class="token function">racereadrangepc</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token function">getcallerpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token function">funcPC</span><span class="token punctuation">(</span>slicebytetostringtmp<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> msanenabled <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                <span class="token function">msanread</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">该函数的“秘诀”就在于不为 string 新开辟一块内存，而是直接使用 slice 的底层存储。当然使用这个函数的前提是：<strong>在原 slice 被修改后，这个 string 不能再被使用了</strong>。因此这样的优化是针对特定场景的，包括：</p>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">string(b)用在 map 类型的 key 中</li>
</ul>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go">b <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token string">'k'</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">}</span>
m <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>
m<span class="token punctuation">[</span><span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"value"</span>
m<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"key1"</span><span class="token punctuation">,</span> <span class="token string">"key2"</span><span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"value1"</span>
</code></pre>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">string(b)用在字符串连接语句中</li>
</ul>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go">b <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'n'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">}</span>
s <span class="token operator">:=</span> <span class="token string">"hello "</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"!"</span>
</code></pre>
</div><div class="cl-preview-section"><ul>
<li style="font-size: 20px; line-height: 38px;">string(b)用于字符串比较中</li>
</ul>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go">s <span class="token operator">:=</span> <span class="token string">"tom"</span>
b <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token string">'t'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'n'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">}</span>

<span class="token keyword">if</span> s <span class="token operator">&lt;</span> <span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span> <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">Go 编译器对用在 for-range 循环中的 string 到[]byte 的转换也有优化处理，Go 编译器不会为[]byte 做额外的内存分配，而是直接使用 string 的底层数据。我们看下面例子：</p>
</div><div class="cl-preview-section"><pre class="  language-go"><code class="prism  language-go"><span class="token comment">// sources/string_for_range_covert_optimize.go</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span> 
        <span class="token string">"fmt"</span>
        <span class="token string">"testing"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        s <span class="token operator">:=</span> <span class="token string">"中国欢迎您，北京欢迎您"</span>
        sl <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> sl <span class="token punctuation">{</span> 
                <span class="token boolean">_</span> <span class="token operator">=</span> v 
        <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">convertWithOptimize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        s <span class="token operator">:=</span> <span class="token string">"中国欢迎您，北京欢迎您"</span>
        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                <span class="token boolean">_</span> <span class="token operator">=</span> v 
        <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>testing<span class="token punctuation">.</span><span class="token function">AllocsPerRun</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> convert<span class="token punctuation">)</span><span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>testing<span class="token punctuation">.</span><span class="token function">AllocsPerRun</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> convertWithOptimize<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> 
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">运行这个例子程序：</p>
</div><div class="cl-preview-section"><pre class="  language-plain"><code class="prism  language-plain">$go run string_for_range_covert_optimize.go
1
0
</code></pre>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">从结果我们看到，convertWithOptimize 函数将 string 到[]byte 的转换放在 for-range 循环中，Go 编译器对其进行了优化，节省了一次内存分配操作。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在如今的强大的硬件算力面前，少数的几次 string 和 slice 的转换代价可能微不足道。但能充分理解 Go 编译器对 string 和 slice 互转在特定场景下的优化依然是大有裨益的。在性能敏感的领域，这些优化也许能起到大作用。</p>
</div><div class="cl-preview-section"><h2 id="小结" style="font-size: 30px;">5. 小结</h2>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">在本小节中，我们了解到 Go 语言内置了 string 类型，统一了对字符串的抽象，并且为 string 类型提供了强大的内置操作支持，包括：基于 +/+= 的字符串连接操作、基于 =、!=、&gt;、&lt; 等的比较操作、O(1) 复杂度的长度获取操作、对非 ASCII 字符提供原生支持、对 string 类型与 slice 类型的相互转换提供优化等。</p>
</div><div class="cl-preview-section"><p style="font-size: 20px; line-height: 38px;">与此同时，Go 语言还在标准库中提供了 <a href="https://tip.golang.org/pkg/strings/">strings</a> 和 <a href="https://tip.golang.org/pkg/strconv/">strconv</a> 包，可以辅助 Gopher 们对 string 类型数据进行更多高级操作。鉴于篇幅有限，这里就不赘述了，大家可以自行查阅以上两个包的使用说明文档。</p>
</div>}
                        </div>
                    </div>
                                            <!-- 买过的阅读 -->
                        <div class="art-next-prev clearfix">
                                                                                                <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/87/article/2383">
                                                                    <div class="prev l clearfix">
                                        <div class="icon l">
                                            <i class="imv2-arrow3_l"></i>
                                        </div>
                                        <p>
                                            14 深入理解和高效运用切片(slice)
                                        </p>
                                    </div>
                                </a>
                                                                                                                            <!-- 已买且开放 或者可以试读 -->
                                    <a href="/read/87/article/2387">
                                                                    <div class="next r clearfix">
                                        <p>
                                            16 理解包导入路径的含义
                                        </p>
                                        <div class="icon r">
                                            <i class="imv2-arrow3_r"></i>
                                        </div>

                                    </div>
                                </a>
                                                    </div>
                                    </div>
                <div class="comments-con js-comments-con" id="coments_con">
                </div>

                
            </div>
            
            
            

        </div>
    </div>
</div>

<div class="modal modal-jiaQun-new hide" id="modal-jiaQun">
    <div class="inner" style="">
        <div class="modal-close js-close-jiaQun">
            <i class="imv2-close"></i>
        </div>
        <div class="content">
            <img src="https://img4.sycdn.imooc.com/5f51ecec0001392b05330597.jpg">
            <div class="right-info">
                <div class="title">
                    扫码加入慕课前沿技术核心用户群
                </div>
                <div class="desc">
                                            <p class="mb6">验证信息：<span id="joincode">2010312025386365</span><span class="copy js-copy-joincode">复制</span></p>
                                        <p class="mb6">QQ讨论群号：729941811</p>
                                            <p>QQ群URL：<a href="https://jq.qq.com/?_wv=1027&amp;k=5WJLMxV" target="_blank">点击访问</a></p>
                                    </div>
            </div>
            <p class="tip">若遇到搜索不到QQ群或加群失败，请联系客服邮箱:kf@imooc.com</p>
        </div>
    </div>
</div>
 
<!-- 专栏介绍页专栏评价 -->

<!-- 专栏介绍页底部三条评价 -->

<!-- 专栏阅读页弹层目录和介绍页页面目录 -->

<!-- 专栏阅读页发布回复 -->

<!-- 专栏阅读页发布评论 -->

<!-- 专栏阅读页底部评论 -->

<!-- 专栏阅读 单个 评论 -->

<!-- 新增回复和展开三条以外回复 -->

<!-- 立即订阅的弹窗 -->












</div></body></html>